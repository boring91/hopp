services:
  # ===================
  # PostgreSQL Database
  # ===================
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-hopp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-hopp}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hopp}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===================
  # Redis (Pub/Sub)
  # ===================
  redis:
    image: redis:alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===================
  # LiveKit Server
  # ===================
  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    command: --config /etc/livekit.yaml --bind 0.0.0.0
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY:?LIVEKIT_API_KEY is required}: ${LIVEKIT_API_SECRET:?LIVEKIT_API_SECRET is required}"
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    ports:
      # WebSocket signaling - nginx proxies to this
      - "7880:7880"
      # WebRTC UDP ports - these MUST be exposed directly (cannot go through nginx)
      - "7881:7881/udp"
      - "50000-50100:50000-50100/udp"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7880"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===================
  # Hopp Backend
  # ===================
  backend:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      args:
        VITE_API_BASE_URL: ${PUBLIC_DOMAIN:?PUBLIC_DOMAIN is required}
    restart: unless-stopped
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "1926"
      USE_TLS: "false"

      # Database
      DATABASE_DSN: "postgres://${POSTGRES_USER:-hopp}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hopp}?sslmode=disable"

      # Redis
      REDIS_URI: "redis://redis:6379/0?protocol=3"

      # LiveKit - This URL is returned to clients, so it must be publicly accessible
      # Format: wss://your-livekit-domain.com (or ws:// for non-TLS)
      LIVEKIT_SERVER_URL: "${LIVEKIT_SERVER_URL:?LIVEKIT_SERVER_URL is required}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET}"

      # Auth
      SESSION_SECRET: "${SESSION_SECRET:?SESSION_SECRET is required}"
      DEPLOY_DOMAIN: "${PUBLIC_DOMAIN:?PUBLIC_DOMAIN is required}"

      # Self-hosted: disable billing/trial restrictions
      DISABLE_BILLING: "${DISABLE_BILLING:-true}"

      # Optional OAuth providers
      GOOGLE_KEY: "${GOOGLE_KEY:-}"
      GOOGLE_SECRET: "${GOOGLE_SECRET:-}"
      GITHUB_KEY: "${GITHUB_KEY:-}"
      GITHUB_SECRET: "${GITHUB_SECRET:-}"
      SLACK_KEY: "${SLACK_KEY:-}"
      SLACK_SECRET: "${SLACK_SECRET:-}"

      # Optional integrations
      RESEND_API_KEY: "${RESEND_API_KEY:-}"
      RESEND_DEFAULT_SENDER: "${RESEND_DEFAULT_SENDER:-}"
      STRIPE_SECRET_KEY: "${STRIPE_SECRET_KEY:-}"
      STRIPE_PUBLISHABLE_KEY: "${STRIPE_PUBLISHABLE_KEY:-}"
      STRIPE_WEBHOOK_SECRET: "${STRIPE_WEBHOOK_SECRET:-}"
      STRIPE_PAID_PRICE_ID: "${STRIPE_PAID_PRICE_ID:-}"
      SENTRY_DSN: "${SENTRY_DSN:-}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN:-}"
      TELEGRAM_CHAT_ID: "${TELEGRAM_CHAT_ID:-}"
    ports:
      - "1926:1926"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      livekit:
        condition: service_healthy
    # For backend to resolve LiveKit's public domain to the container
    # Uncomment and adjust if your domain doesn't resolve to the host
    # extra_hosts:
    #   - "livekit.${PUBLIC_DOMAIN}:host-gateway"

volumes:
  postgres_data:
  redis_data:
